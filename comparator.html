<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Multi-Model Comparator</title>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --card: #ffffff; --border: #e2e8f0; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; height: 100vh; display: flex; flex-direction: column; overflow: hidden; color: #1e293b; }
        
        /* Layout */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: white; padding: 10px 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .grid-container { display: flex; gap: 15px; flex: 1; overflow: hidden; }
        
        /* Panels */
        .panel { background: var(--card); border-radius: 8px; display: flex; flex-direction: column; border: 1px solid var(--border); overflow: hidden; flex: 1; }
        .context-panel { flex: 0 0 20%; background: #f1f5f9; border-left: 4px solid var(--primary); }
        
        /* Headers & Content */
        .panel-header { padding: 12px; font-weight: bold; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .panel-content { flex: 1; overflow-y: auto; padding: 15px; font-size: 0.95em; line-height: 1.6; white-space: normal; }
        
        /* Model Specific Colors */
        .model-0-header { border-top: 4px solid #ef4444; } /* Red */
        .model-1-header { border-top: 4px solid #22c55e; } /* Green */
        .model-2-header { border-top: 4px solid #eab308; } /* Yellow */

        /* Buttons */
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-nav { background: #cbd5e1; color: #334155; }
        .btn-nav:hover { background: #94a3b8; color: white; }
        .btn-save { background: var(--primary); color: white; }
        
        /* Vote Footer */
        .vote-footer { padding: 10px; border-top: 1px solid var(--border); text-align: center; background: #f8fafc; }
        .vote-btn { width: 100%; padding: 8px; border: 1px solid #cbd5e1; background: white; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .vote-btn:hover { background: #e2e8f0; }
        .vote-btn.selected { background: #3b82f6; color: white; border-color: #3b82f6; }

        .context-content { display: flex; flex-direction: column; gap: 12px; }
        .context-section { display: flex; flex-direction: column; gap: 4px; }
        .context-title { font-size: 1.05em; font-weight: 600; color: #0f172a; }
        .context-meta { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; }
        .meta-label { font-size: 0.7em; text-transform: uppercase; letter-spacing: 0.08em; color: #94a3b8; margin-bottom: 2px; }
        .meta-value { font-weight: 600; color: #0f172a; }
        .section-label { font-size: 0.75em; text-transform: uppercase; letter-spacing: 0.08em; color: #94a3b8; margin-bottom: 4px; }
        .section-body { background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 10px; min-height: 48px; }
        .rich-text p { margin: 0 0 6px 0; }
        .rich-text ul { margin: 0 0 6px 20px; }
        .model-section { margin-bottom: 16px; }
        .model-empty { background: #fef2f2; border: 1px dashed #fecaca; border-radius: 8px; padding: 12px; color: #b91c1c; }
        .context-footer { padding: 15px; border-top: 1px solid #ddd; font-size: 0.85em; background: #fff; }

    </style>
</head>
<body onload="init()">

    <div class="header">
        <div style="display:flex; align-items:center; gap:15px;">
            <h2 style="margin:0; font-size:1.2em;">‚öñÔ∏è Multi-Model Comparator</h2>
            <span id="progress" style="background:#e2e8f0; padding:4px 8px; border-radius:4px; font-size:0.85em;">Loading...</span>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-nav" onclick="nav(-1)">Previous</button>
            <button class="btn btn-nav" onclick="nav(1)">Next</button>
            <button class="btn btn-save" onclick="downloadCSV()">üíæ Download Results</button>
        </div>
    </div>

    <div style="margin-bottom: 10px; display: flex; gap: 20px; align-items: center;">
        <div>
            <label for="project-select">Project: </label>
            <select id="project-select" onchange="onProjectChange()"></select>
        </div>
        <div id="model-select-container" style="display:none; position:relative;">
            <span id="model-select-summary" style="margin-right: 10px;">Select models</span>
            <button id="model-select-modify" onclick="openModelDropdown(event)" aria-haspopup="dialog" aria-controls="model-select-list">Modify</button>
            <div id="model-select-dialog" style="display:none; position:absolute; z-index:10; background:white; border:1px solid #ccc; border-radius:4px; margin-top:4px; min-width:220px; max-width:320px; max-height:220px; overflow:auto; box-shadow:0 2px 8px #0002;">
                <div style="padding:8px 12px; font-weight:bold;">Select models to compare</div>
                <ul id="model-select-list" role="listbox" aria-multiselectable="true" tabindex="-1" style="margin:0; padding:4px 0; list-style:none;"></ul>
                <div style="padding:8px 12px; text-align:right;">
                    <button onclick="closeModelDropdown()">Done</button>
                </div>
            </div>
        </div>
    </div>
    <div class="grid-container" id="main-grid">
        <div class="panel context-panel">
            <div class="panel-header">Context & Inputs</div>
            <div class="panel-content context-content">
                <div class="context-title" id="context-title">Issue context</div>
                <div class="context-meta">
                    <div>
                        <div class="meta-label">Project</div>
                        <div class="meta-value" id="context-project">‚Äî</div>
                    </div>
                    <div>
                        <div class="meta-label">Status</div>
                        <div class="meta-value" id="context-status">‚Äî</div>
                    </div>
                    <div>
                        <div class="meta-label">Priority</div>
                        <div class="meta-value" id="context-priority">‚Äî</div>
                    </div>
                    <div>
                        <div class="meta-label">Component</div>
                        <div class="meta-value" id="context-component">‚Äî</div>
                    </div>
                    <div>
                        <div class="meta-label">Version</div>
                        <div class="meta-value" id="context-version">‚Äî</div>
                    </div>
                    <div>
                        <div class="meta-label">Created</div>
                        <div class="meta-value" id="context-created">‚Äî</div>
                    </div>
                    <div>
                        <div class="meta-label">WCAG</div>
                        <div class="meta-value" id="context-wcag">‚Äî</div>
                    </div>
                </div>
                <div class="context-section">
                    <div class="section-label">Description</div>
                    <div class="section-body rich-text" id="context-text"></div>
                </div>
            </div>
            <div class="context-footer">
                <div>ID: <strong id="item-id"></strong></div>
                <div style="margin-top:5px;"><a id="source-link" href="#" target="_blank">üîó View Source URL</a></div>
            </div>
        </div>

        </div>

    <script>

        let allData = [];
        let data = [];
        let index = 0;
        let results = {}; // { id: { choice: 'model_filename', comment: '' } }
        let projects = [];
        let selectedProject = null;
        let allModels = [];
        let selectedModels = [];
        let modelDropdownOpen = false;

        function escapeHtml(text) {
            if (!text) return "";
            return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        function formatReport(text) {
            if (!text) return "";
            const lines = String(text).split('\n');
            let inUnorderedList = false;
            let inOrderedList = false;
            let inBlockquote = false;
            const htmlLines = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmedLine = line.trim();

                if (/^(#{1,6})\s+(.+)$/.test(trimmedLine)) {
                    if (inUnorderedList) { htmlLines.push('</ul>'); inUnorderedList = false; }
                    if (inOrderedList) { htmlLines.push('</ol>'); inOrderedList = false; }
                    if (inBlockquote) { htmlLines.push('</blockquote>'); inBlockquote = false; }
                    const match = trimmedLine.match(/^(#{1,6})\s+(.+)$/);
                    const level = match[1].length;
                    const content = escapeHtml(match[2]);
                    htmlLines.push(`<h${level} style="margin:8px 0 5px 0; font-weight:bold; color:#1e293b;">${content}</h${level}>`);
                } else if (/^>\s*/.test(trimmedLine)) {
                    if (inUnorderedList) { htmlLines.push('</ul>'); inUnorderedList = false; }
                    if (inOrderedList) { htmlLines.push('</ol>'); inOrderedList = false; }
                    if (!inBlockquote) {
                        htmlLines.push('<blockquote style="margin:10px 0; padding:10px 15px; border-left:4px solid #cbd5e1; background:#f8fafc; color:#475569;">');
                        inBlockquote = true;
                    }
                    const content = trimmedLine.replace(/^>\s*/, '');
                    const afterQuote = line.substring(line.indexOf('>') + 1);
                    if (/^\s{4,}/.test(afterQuote) || afterQuote.startsWith('\t')) {
                        htmlLines.push(`<div style="margin-left:20px; font-family:monospace; white-space:pre-wrap;">${escapeHtml(content)}</div>`);
                    } else if (content) {
                        htmlLines.push(`<div>${escapeHtml(content)}</div>`);
                    } else {
                        htmlLines.push('<div><br></div>');
                    }
                } else if (/^\d+\.\s+/.test(trimmedLine)) {
                    if (inUnorderedList) { htmlLines.push('</ul>'); inUnorderedList = false; }
                    if (inBlockquote) { htmlLines.push('</blockquote>'); inBlockquote = false; }
                    if (!inOrderedList) {
                        htmlLines.push('<ol style="margin:5px 0; padding-left:20px;">');
                        inOrderedList = true;
                    }
                    const content = trimmedLine.replace(/^\d+\.\s+/, '');
                    const processed = escapeHtml(content).replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    htmlLines.push(`<li style="margin-bottom:3px;">${processed}</li>`);
                } else if (/^[\*\-]\s+/.test(trimmedLine)) {
                    if (inOrderedList) { htmlLines.push('</ol>'); inOrderedList = false; }
                    if (inBlockquote) { htmlLines.push('</blockquote>'); inBlockquote = false; }
                    if (!inUnorderedList) {
                        htmlLines.push('<ul style="margin:5px 0; padding-left:20px; list-style-type:disc;">');
                        inUnorderedList = true;
                    }
                    const content = trimmedLine.replace(/^[\*\-]\s+/, '');
                    const processed = escapeHtml(content).replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    htmlLines.push(`<li style="margin-bottom:3px;">${processed}</li>`);
                } else {
                    if (inBlockquote && trimmedLine === '') {
                        if (i + 1 < lines.length && /^>\s*/.test(lines[i + 1].trim())) {
                            htmlLines.push('<div><br></div>');
                            continue;
                        } else {
                            htmlLines.push('</blockquote>');
                            inBlockquote = false;
                        }
                    }
                    if (inUnorderedList) { htmlLines.push('</ul>'); inUnorderedList = false; }
                    if (inOrderedList) { htmlLines.push('</ol>'); inOrderedList = false; }
                    if (trimmedLine) {
                        const processedLine = escapeHtml(line).replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                        htmlLines.push(processedLine);
                    } else {
                        if (htmlLines.length > 0 && htmlLines[htmlLines.length - 1] !== '<br>') {
                            htmlLines.push('<br>');
                        }
                    }
                }
            }

            if (inUnorderedList) { htmlLines.push('</ul>'); }
            if (inOrderedList) { htmlLines.push('</ol>'); }
            if (inBlockquote) { htmlLines.push('</blockquote>'); }
            while (htmlLines.length > 0 && htmlLines[htmlLines.length - 1] === '<br>') {
                htmlLines.pop();
            }
            return htmlLines.join('\n');
        }

        function renderJourney(text, issueUrl) {
            if (!text) return "No thread analysis available";
            let html = escapeHtml(text);
            html = html.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color:#2563eb; text-decoration:underline;">$1</a>');
            const parts = html.split(/(?=#\d+)/);
            if (parts.length > 1) {
                return '<div class="journey-list">' + parts.map(p => {
                    const trimmed = p.trim();
                    if (!trimmed) return '';
                    const match = trimmed.match(/^(#\d+)(.*)/s);
                    if (match) {
                        const id = match[1];
                        const content = match[2].trim();
                        const linkHref = issueUrl ? `${issueUrl}${id}` : '#';
                        return `<div class="journey-item" style="margin-bottom:2px;"><a href="${linkHref}" target="_blank" class="journey-id" style="font-weight:bold; color:#2563eb; margin-right:5px; text-decoration:none;">${id}</a><span class="journey-content">${content}</span></div>`;
                    }
                    return `<div class="journey-item" style="margin-bottom:2px;">${trimmed}</div>`;
                }).join('') + '</div>';
            }
            return html;
        }

        function renderList(text) {
            if (!text) return "";
            let html = escapeHtml(text);
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color:#2563eb; text-decoration:underline;">$1</a>');
            if (html.includes('\n')) {
                const lines = html.split('\n');
                const listItems = lines.map(line => {
                    const trimmed = line.trim();
                    const match = trimmed.match(/^[\*\-]\s+(.*)/);
                    if (match) {
                        return `<li>${match[1].trim()}</li>`;
                    }
                    return trimmed ? `<p>${trimmed}</p>` : '';
                }).join('');
                if (listItems.includes('<li>')) {
                    return `<ul style="padding-left:20px; margin:0;">${listItems}</ul>`;
                }
                return listItems;
            }
            if (html.match(/(?:^|\s)[\*\-]\s/)) {
                let list = html.replace(/^[\*\-]\s+/, '');
                const items = list.split(/\s+[\*\-]\s+/);
                const content = items.map(item => `<li>${item.trim()}</li>`).join('');
                return `<ul style="padding-left:20px; margin:0;">${content}</ul>`;
            }
            return html;
        }

        function setContextField(id, value) {
            const el = document.getElementById(id);
            if (!el) return;
            const text = value && String(value).trim() ? value : '‚Äî';
            el.textContent = text;
        }

        function buildModelContent(model, issueUrl) {
            if (!model) {
                return '<div class="model-empty">This scan did not produce output for this issue.</div>';
            }
            const sections = [];
            const addSection = (label, value, renderer = formatReport) => {
                const text = value && String(value).trim() ? String(value) : '';
                if (!text) return;
                sections.push(`
                    <div class="model-section">
                        <div class="section-label">${label}</div>
                        <div class="section-body rich-text">${renderer(text, issueUrl)}</div>
                    </div>
                `);
            };

            addSection('WCAG Mapping', model?.ai_wcag, escapeHtml);
            addSection('ACR Note', model?.acr_note || model?.text);
            addSection('Developer Note', model?.dev_note);
            addSection('Thread TL;DR', model?.thread_tldr);
            addSection('Thread Problem', model?.thread_problem);
            addSection('Thread Sentiment', model?.thread_sentiment);
            addSection('Thread Timeline', model?.thread_timeline, renderJourney);
            addSection('Thread Links', model?.thread_links, renderList);
            addSection('Thread TODO', model?.thread_todo);
            addSection('Thread Journey', model?.thread_journey, renderJourney);

            if (sections.length === 0) {
                const fallback = model?.text ? formatReport(model.text) : '';
                return `<div class="model-empty">${fallback || 'No AI analysis captured for this scan.'}</div>`;
            }
            return sections.join('');
        }

        function buildAssetUrl(path) {
            const cleaned = (path || '').replace(/^\/+/, '');
            const currentPath = window.location.pathname || '/';
            let basePath = currentPath.replace(/[^\/]*$/, '');
            const lastSegment = currentPath.substring(currentPath.lastIndexOf('/') + 1);
            const looksLikeFile = lastSegment.includes('.');
            if (basePath === '/' && currentPath !== '/' && !looksLikeFile) {
                basePath = currentPath.endsWith('/') ? currentPath : currentPath + '/';
            }
            const baseUrl = window.location.origin + basePath;
            return new URL(cleaned, baseUrl).href;
        }

        async function init() {
            try {
                // Load projects with multiple runs
                const projRes = await fetch(buildAssetUrl('results/projects_with_multiple_runs.json'));
                const allProjectsObj = await projRes.json();
                // Load all comparison data
                const res = await fetch(buildAssetUrl('results/comparison.json'));
                let rawData = await res.json();
                // For each model in each item, check if its run folder exists by attempting to fetch its CSV file
                async function modelExists(model) {
                    // Use the csv_path property if present
                    if (!model.csv_path) return false;
                    try {
                        const test = await fetch(buildAssetUrl(model.csv_path), {method: 'HEAD'});
                        return test.ok;
                    } catch (e) { return false; }
                }
                // Filter models by existence
                async function filterModelsByExistence(data) {
                    let filtered = [];
                    for (const item of data) {
                        let validModels = [];
                        for (const m of item.models) {
                            if (await modelExists(m)) validModels.push(m);
                        }
                        if (validModels.length > 0) {
                            filtered.push({...item, models: validModels});
                        }
                    }
                    return filtered;
                }
                allData = await filterModelsByExistence(rawData);
                // Only include projects that have at least one valid model
                projects = Object.keys(allProjectsObj).filter(p =>
                    allData.some(item =>
                        item.project === p || item.models.some(m => m.model_name.startsWith(p + '-'))
                    )
                );
                const select = document.getElementById('project-select');
                select.innerHTML = '';
                if (projects.length === 0) {
                    select.innerHTML = '<option>No projects with multiple runs</option>';
                    document.getElementById('main-grid').style.display = 'none';
                    document.getElementById('progress').textContent = 'No projects to compare';
                    return;
                }
                projects.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p;
                    opt.textContent = p;
                    select.appendChild(opt);
                });
                selectedProject = projects[0];
                filterDataByProject();
            } catch (e) { console.error(e); }
        }

        function onProjectChange() {
            const select = document.getElementById('project-select');
            selectedProject = select.value;
            filterDataByProject();
        }

        function openModelDropdown(e) {
            e.preventDefault();
            modelDropdownOpen = true;
            // Update checkboxes to reflect current selectedModels
            const modelSelectList = document.getElementById('model-select-list');
            Array.from(modelSelectList.querySelectorAll('input[type=checkbox]')).forEach(cb => {
                cb.checked = selectedModels.includes(cb.value);
            });
            document.getElementById('model-select-dialog').style.display = '';
            modelSelectList.focus();
        }

        function closeModelDropdown() {
            modelDropdownOpen = false;
            document.getElementById('model-select-dialog').style.display = 'none';
            document.getElementById('model-select-modify').focus();
        }

        function onModelCheckboxChange() {
            const checkboxes = document.querySelectorAll('#model-select-list input[type=checkbox]');
            selectedModels = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
            if (selectedModels.length === 0 && allModels.length > 0) {
                selectedModels = [...allModels];
                checkboxes.forEach(cb => {
                    cb.checked = selectedModels.includes(cb.value);
                });
            }
            updateModelSummary();
            filterDataByProject(false);
        }

        function updateModelSummary() {
            const summary = document.getElementById('model-select-summary');
            summary.textContent = `${selectedModels.length}/${allModels.length} scans enabled`;
        }

        // Keyboard navigation for accessibility
        document.addEventListener('keydown', function(e) {
            if (!modelDropdownOpen) return;
            if (e.key === 'Escape') {
                closeModelDropdown();
            } else if (e.key === 'Tab') {
                // Trap focus inside dialog
                const dialog = document.getElementById('model-select-dialog');
                const focusable = dialog.querySelectorAll('button, [tabindex]:not([tabindex="-1"])');
                const first = focusable[0];
                const last = focusable[focusable.length-1];
                if (e.shiftKey ? document.activeElement === first : document.activeElement === last) {
                    e.preventDefault();
                    (e.shiftKey ? last : first).focus();
                }
            }
        });

        function filterDataByProject(resetModels = true) {
            // Get all models for this project
            const projectItems = allData.filter(item => {
                if (item.project) return item.project === selectedProject;
                return item.models.some(m => m.model_name.startsWith(selectedProject + '-'));
            });
            // Collect all unique model names for this project
            const modelSet = new Set();
            projectItems.forEach(item => {
                item.models.forEach(m => {
                    if (item.project === selectedProject || m.model_name.startsWith(selectedProject + '-')) {
                        modelSet.add(m.model_name);
                    }
                });
            });
            allModels = Array.from(modelSet);
            // If more than 2 models, show accessible summary and modify button
            const modelSelectDiv = document.getElementById('model-select-container');
            const modelSelectList = document.getElementById('model-select-list');
            if (allModels.length > 2) {
                modelSelectDiv.style.display = '';
                modelSelectList.innerHTML = '';
                allModels.forEach((m, idx) => {
                    const li = document.createElement('li');
                    li.setAttribute('role', 'option');
                    li.setAttribute('aria-selected', selectedModels.includes(m) ? 'true' : 'false');
                    li.style.display = 'flex';
                    li.style.alignItems = 'center';
                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.value = m;
                    cb.id = 'model-cb-' + idx;
                    cb.checked = selectedModels.includes(m);
                    cb.setAttribute('aria-label', m);
                    cb.onchange = onModelCheckboxChange;
                    li.appendChild(cb);
                    const lbl = document.createElement('label');
                    lbl.htmlFor = cb.id;
                    lbl.textContent = m;
                    lbl.style.marginLeft = '8px';
                    li.appendChild(lbl);
                    modelSelectList.appendChild(li);
                });
                // Select first 3-4 models by default or keep previous selection
                if (resetModels || selectedModels.length === 0) {
                    selectedModels = allModels.slice(0, Math.min(4, allModels.length));
                }
                updateModelSummary();
            } else {
                modelSelectDiv.style.display = 'none';
                selectedModels = [...allModels];
            }
            // Filter data to only include selected models
            data = projectItems.map(item => {
                // Only keep selected models for this item
                return {
                    ...item,
                    models: item.models.filter(m => selectedModels.includes(m.model_name))
                };
            }).filter(item => item.models.length > 0);
            index = 0;
            if (data.length > 0) {
                document.getElementById('main-grid').style.display = 'flex';
                generateLayout(getTemplateModels());
                render();
            } else {
                document.getElementById('main-grid').style.display = 'none';
                document.getElementById('progress').textContent = 'No data for selected project/models';
            }
        }

        // Close dropdown if clicking outside
        document.addEventListener('mousedown', function(e) {
            const dialog = document.getElementById('model-select-dialog');
            if (modelDropdownOpen && dialog && !dialog.contains(e.target) && e.target.id !== 'model-select-modify') {
                closeModelDropdown();
            }
        });

        function getTemplateModels() {
            if (!selectedModels || selectedModels.length === 0) return [];
            return selectedModels.map(name => {
                const source = (data.find(item => item.models.some(m => m.model_name === name)) ||
                    allData.find(item => item.models.some(m => m.model_name === name)));
                if (source) {
                    return source.models.find(m => m.model_name === name) || { model_name: name };
                }
                return { model_name: name };
            });
        }

        function generateLayout(models) {
            const grid = document.getElementById('main-grid');
            // Keep context panel, remove old model panels if any
            while (grid.children.length > 1) { grid.removeChild(grid.lastChild); }
            models.forEach((model, i) => {
                const modelName = model?.model_name || selectedModels[i] || `Model ${i + 1}`;
                const div = document.createElement('div');
                div.className = `panel model-${i}-header`;
                div.setAttribute('data-model-panel', i);
                div.innerHTML = `
                    <div class="panel-header">
                        <span>${escapeHtml(modelName)}</span>
                        <span style="font-size:0.8em; color:#666;">Model ${i+1}</span>
                    </div>
                    <div class="panel-content" id="model-content-${i}"></div>
                    <div class="vote-footer">
                        <button class="vote-btn" id="btn-vote-${i}" data-model="${escapeHtml(modelName)}" onclick="vote(this.dataset.model)">
                            Vote for Model ${i+1}
                        </button>
                    </div>
                `;
                grid.appendChild(div);
            });
        }

        function render() {
            const item = data[index];
            document.getElementById('progress').textContent = `${index + 1} of ${data.length}`;
            const description = item.description || item.context || '';
            const formattedDescription = formatReport(description);
            document.getElementById('context-text').innerHTML = formattedDescription || '<em>No description provided.</em>';
            document.getElementById('context-title').textContent = item.title || `Issue ${item.id}`;
            setContextField('context-project', item.project || selectedProject || '‚Äî');
            setContextField('context-status', item.status || 'Unknown');
            setContextField('context-priority', item.priority || 'Unknown');
            setContextField('context-component', item.component || '‚Äî');
            setContextField('context-version', item.version || '‚Äî');
            setContextField('context-created', item.created || '‚Äî');
            setContextField('context-wcag', item.wcag_sc || '‚Äî');

            document.getElementById('item-id').textContent = item.id || '‚Äî';
            const url = item.source_url || '';
            const sourceLink = document.getElementById('source-link');
            if (url) {
                sourceLink.href = url;
                sourceLink.textContent = 'üîó View Source URL';
                sourceLink.removeAttribute('aria-disabled');
            } else {
                sourceLink.href = '#';
                sourceLink.textContent = 'No source link available';
                sourceLink.setAttribute('aria-disabled', 'true');
            }

            const totalPanels = selectedModels.length;
            for (let i = 0; i < totalPanels; i++) {
                const modelName = selectedModels[i];
                const modelData = item.models.find(m => m.model_name === modelName);
                const container = document.getElementById(`model-content-${i}`);
                if (container) {
                    container.innerHTML = buildModelContent(modelData, item.source_url);
                }
                const voteBtn = document.getElementById(`btn-vote-${i}`);
                if (voteBtn) {
                    voteBtn.dataset.model = modelName;
                }
            }

            // Restore Vote
            document.querySelectorAll('.vote-btn').forEach(b => b.classList.remove('selected'));
            const saved = results[item.id];
            if (saved) {
                selectedModels.forEach((name, i) => {
                    if (name === saved.choice) {
                        const btn = document.getElementById(`btn-vote-${i}`);
                        if (btn) btn.classList.add('selected');
                    }
                });
            }
        }

        function vote(modelName) {
            results[data[index].id] = { choice: modelName, timestamp: new Date().toISOString() };
            render(); // Re-render to update classes
        }

        function nav(dir) {
            const newIndex = index + dir;
            if (newIndex >= 0 && newIndex < data.length) {
                index = newIndex;
                render();
            }
        }

        function downloadCSV() {
            const headers = ['id', 'preferred_model', 'timestamp'];
            let csv = headers.join(',') + '\n';
            
            data.forEach(item => {
                const res = results[item.id] || {};
                csv += `"${item.id}","${res.choice || 'Skipped'}","${res.timestamp || ''}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'comparison_results.csv';
            document.body.appendChild(a);
            a.click();
        }
    </script>
</body>
</html>
