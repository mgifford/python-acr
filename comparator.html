<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Multi-Model Comparator</title>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --card: #ffffff; --border: #e2e8f0; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; height: 100vh; display: flex; flex-direction: column; overflow: hidden; color: #1e293b; }
        
        /* Layout */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: white; padding: 10px 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .grid-container { display: flex; gap: 15px; flex: 1; overflow: hidden; }
        
        /* Panels */
        .panel { background: var(--card); border-radius: 8px; display: flex; flex-direction: column; border: 1px solid var(--border); overflow: hidden; flex: 1; }
        .context-panel { flex: 0 0 20%; background: #f1f5f9; border-left: 4px solid var(--primary); }
        
        /* Headers & Content */
        .panel-header { padding: 12px; font-weight: bold; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .panel-content { flex: 1; overflow-y: auto; padding: 15px; font-size: 0.95em; line-height: 1.6; white-space: pre-wrap; }
        
        /* Model Specific Colors */
        .model-0-header { border-top: 4px solid #ef4444; } /* Red */
        .model-1-header { border-top: 4px solid #22c55e; } /* Green */
        .model-2-header { border-top: 4px solid #eab308; } /* Yellow */

        /* Buttons */
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-nav { background: #cbd5e1; color: #334155; }
        .btn-nav:hover { background: #94a3b8; color: white; }
        .btn-save { background: var(--primary); color: white; }
        
        /* Vote Footer */
        .vote-footer { padding: 10px; border-top: 1px solid var(--border); text-align: center; background: #f8fafc; }
        .vote-btn { width: 100%; padding: 8px; border: 1px solid #cbd5e1; background: white; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .vote-btn:hover { background: #e2e8f0; }
        .vote-btn.selected { background: #3b82f6; color: white; border-color: #3b82f6; }

    </style>
</head>
<body onload="init()">

    <div class="header">
        <div style="display:flex; align-items:center; gap:15px;">
            <h2 style="margin:0; font-size:1.2em;">‚öñÔ∏è Multi-Model Comparator</h2>
            <span id="progress" style="background:#e2e8f0; padding:4px 8px; border-radius:4px; font-size:0.85em;">Loading...</span>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-nav" onclick="nav(-1)">Previous</button>
            <button class="btn btn-nav" onclick="nav(1)">Next</button>
            <button class="btn btn-save" onclick="downloadCSV()">üíæ Download Results</button>
        </div>
    </div>

    <div style="margin-bottom: 10px; display: flex; gap: 20px; align-items: center;">
        <div>
            <label for="project-select">Project: </label>
            <select id="project-select" onchange="onProjectChange()"></select>
        </div>
        <div id="model-select-container" style="display:none; position:relative;">
            <span id="model-select-summary" style="margin-right: 10px;">Select models</span>
            <button id="model-select-modify" onclick="openModelDropdown(event)" aria-haspopup="dialog" aria-controls="model-select-list">Modify</button>
            <div id="model-select-dialog" style="display:none; position:absolute; z-index:10; background:white; border:1px solid #ccc; border-radius:4px; margin-top:4px; min-width:220px; max-width:320px; max-height:220px; overflow:auto; box-shadow:0 2px 8px #0002;">
                <div style="padding:8px 12px; font-weight:bold;">Select models to compare</div>
                <ul id="model-select-list" role="listbox" aria-multiselectable="true" tabindex="-1" style="margin:0; padding:4px 0; list-style:none;"></ul>
                <div style="padding:8px 12px; text-align:right;">
                    <button onclick="closeModelDropdown()">Done</button>
                </div>
            </div>
        </div>
    </div>
    <div class="grid-container" id="main-grid">
        <div class="panel context-panel">
            <div class="panel-header">Context & Inputs</div>
            <div class="panel-content" id="context-text"></div>
            <div style="padding:15px; border-top:1px solid #ddd; font-size:0.85em;">
                <div>ID: <strong id="item-id"></strong></div>
                <div style="margin-top:5px;"><a id="source-link" href="#" target="_blank">üîó View Source URL</a></div>
            </div>
        </div>

        </div>

    <script>

        let allData = [];
        let data = [];
        let index = 0;
        let results = {}; // { id: { choice: 'model_filename', comment: '' } }
        let projects = [];
        let selectedProject = null;
        let allModels = [];
        let selectedModels = [];
        let modelDropdownOpen = false;

        function buildAssetUrl(path) {
            const cleaned = (path || '').replace(/^\/+/, '');
            const basePath = window.location.pathname.replace(/[^\/]*$/, '');
            const baseUrl = window.location.origin + basePath;
            return new URL(cleaned, baseUrl).href;
        }

        async function init() {
            try {
                // Load projects with multiple runs
                const projRes = await fetch(buildAssetUrl('results/projects_with_multiple_runs.json'));
                const allProjectsObj = await projRes.json();
                // Load all comparison data
                const res = await fetch(buildAssetUrl('results/comparison.json'));
                let rawData = await res.json();
                // For each model in each item, check if its run folder exists by attempting to fetch its CSV file
                async function modelExists(model) {
                    // Use the csv_path property if present
                    if (!model.csv_path) return false;
                    try {
                        const test = await fetch(buildAssetUrl(model.csv_path), {method: 'HEAD'});
                        return test.ok;
                    } catch (e) { return false; }
                }
                // Filter models by existence
                async function filterModelsByExistence(data) {
                    let filtered = [];
                    for (const item of data) {
                        let validModels = [];
                        for (const m of item.models) {
                            if (await modelExists(m)) validModels.push(m);
                        }
                        if (validModels.length > 0) {
                            filtered.push({...item, models: validModels});
                        }
                    }
                    return filtered;
                }
                allData = await filterModelsByExistence(rawData);
                // Only include projects that have at least one valid model
                projects = Object.keys(allProjectsObj).filter(p =>
                    allData.some(item => item.models.some(m => m.model_name.startsWith(p + '-')))
                );
                const select = document.getElementById('project-select');
                select.innerHTML = '';
                if (projects.length === 0) {
                    select.innerHTML = '<option>No projects with multiple runs</option>';
                    document.getElementById('main-grid').style.display = 'none';
                    document.getElementById('progress').textContent = 'No projects to compare';
                    return;
                }
                projects.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p;
                    opt.textContent = p;
                    select.appendChild(opt);
                });
                selectedProject = projects[0];
                filterDataByProject();
            } catch (e) { console.error(e); }
        }

        function onProjectChange() {
            const select = document.getElementById('project-select');
            selectedProject = select.value;
            filterDataByProject();
        }

        function openModelDropdown(e) {
            e.preventDefault();
            modelDropdownOpen = true;
            // Update checkboxes to reflect current selectedModels
            const modelSelectList = document.getElementById('model-select-list');
            Array.from(modelSelectList.querySelectorAll('input[type=checkbox]')).forEach(cb => {
                cb.checked = selectedModels.includes(cb.value);
            });
            document.getElementById('model-select-dialog').style.display = '';
            modelSelectList.focus();
        }

        function closeModelDropdown() {
            modelDropdownOpen = false;
            document.getElementById('model-select-dialog').style.display = 'none';
            document.getElementById('model-select-modify').focus();
        }

        function onModelCheckboxChange() {
            const checkboxes = document.querySelectorAll('#model-select-list input[type=checkbox]');
            selectedModels = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
            updateModelSummary();
            filterDataByProject(false);
        }

        function updateModelSummary() {
            const summary = document.getElementById('model-select-summary');
            summary.textContent = `${selectedModels.length}/${allModels.length} scans enabled`;
        }

        // Keyboard navigation for accessibility
        document.addEventListener('keydown', function(e) {
            if (!modelDropdownOpen) return;
            if (e.key === 'Escape') {
                closeModelDropdown();
            } else if (e.key === 'Tab') {
                // Trap focus inside dialog
                const dialog = document.getElementById('model-select-dialog');
                const focusable = dialog.querySelectorAll('button, [tabindex]:not([tabindex="-1"])');
                const first = focusable[0];
                const last = focusable[focusable.length-1];
                if (e.shiftKey ? document.activeElement === first : document.activeElement === last) {
                    e.preventDefault();
                    (e.shiftKey ? last : first).focus();
                }
            }
        });

        function filterDataByProject(resetModels = true) {
            // Get all models for this project
            const projectItems = allData.filter(item => item.models.some(m => m.model_name.startsWith(selectedProject + '-')));
            // Collect all unique model names for this project
            let modelSet = new Set();
            projectItems.forEach(item => {
                item.models.forEach(m => {
                    if (m.model_name.startsWith(selectedProject + '-')) modelSet.add(m.model_name);
                });
            });
            allModels = Array.from(modelSet);
            // If more than 2 models, show accessible summary and modify button
            const modelSelectDiv = document.getElementById('model-select-container');
            const modelSelectList = document.getElementById('model-select-list');
            if (allModels.length > 2) {
                modelSelectDiv.style.display = '';
                modelSelectList.innerHTML = '';
                allModels.forEach((m, idx) => {
                    const li = document.createElement('li');
                    li.setAttribute('role', 'option');
                    li.setAttribute('aria-selected', selectedModels.includes(m) ? 'true' : 'false');
                    li.style.display = 'flex';
                    li.style.alignItems = 'center';
                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.value = m;
                    cb.id = 'model-cb-' + idx;
                    cb.checked = selectedModels.includes(m);
                    cb.setAttribute('aria-label', m);
                    cb.onchange = onModelCheckboxChange;
                    li.appendChild(cb);
                    const lbl = document.createElement('label');
                    lbl.htmlFor = cb.id;
                    lbl.textContent = m;
                    lbl.style.marginLeft = '8px';
                    li.appendChild(lbl);
                    modelSelectList.appendChild(li);
                });
                // Select first 3-4 models by default or keep previous selection
                if (resetModels || selectedModels.length === 0) {
                    selectedModels = allModels.slice(0, Math.min(4, allModels.length));
                }
                updateModelSummary();
            } else {
                modelSelectDiv.style.display = 'none';
                selectedModels = allModels;
            }
            // Filter data to only include selected models
            data = projectItems.map(item => {
                // Only keep selected models for this item
                return {
                    ...item,
                    models: item.models.filter(m => selectedModels.includes(m.model_name))
                };
            }).filter(item => item.models.length > 0);
            index = 0;
            if (data.length > 0) {
                generateLayout(data[0].models);
                render();
            } else {
                document.getElementById('main-grid').style.display = 'none';
                document.getElementById('progress').textContent = 'No data for selected project/models';
            }
        }

        // Close dropdown if clicking outside
        document.addEventListener('mousedown', function(e) {
            const dialog = document.getElementById('model-select-dialog');
            if (modelDropdownOpen && dialog && !dialog.contains(e.target) && e.target.id !== 'model-select-modify') {
                closeModelDropdown();
            }
        });

        function generateLayout(models) {
            const grid = document.getElementById('main-grid');
            // Keep context panel, remove old model panels if any
            while (grid.children.length > 1) { grid.removeChild(grid.lastChild); }
            models.forEach((model, i) => {
                const div = document.createElement('div');
                div.className = `panel model-${i}-header`;
                div.innerHTML = `
                    <div class="panel-header">
                        <span>${model.model_name}</span>
                        <span style="font-size:0.8em; color:#666;">Model ${i+1}</span>
                    </div>
                    <div class="panel-content" id="text-model-${i}"></div>
                    <div class="vote-footer">
                        <button class="vote-btn" id="btn-vote-${i}" onclick="vote('${model.model_name}')">
                            Vote for Model ${i+1}
                        </button>
                    </div>
                `;
                grid.appendChild(div);
            });
        }

        function render() {
            const item = data[index];
            document.getElementById('progress').textContent = `${index + 1} of ${data.length}`;
            document.getElementById('context-text').textContent = item.context;
            document.getElementById('item-id').textContent = item.id;
            document.getElementById('source-link').href = item.source_url || '#';

            // Render Model Texts
            item.models.forEach((model, i) => {
                document.getElementById(`text-model-${i}`).textContent = model.text;
            });

            // Restore Vote
            const saved = results[item.id];
            document.querySelectorAll('.vote-btn').forEach(b => b.classList.remove('selected'));
            if (saved) {
                // Find button that corresponds to the saved model name
                item.models.forEach((m, i) => {
                    if(m.model_name === saved.choice) {
                        document.getElementById(`btn-vote-${i}`).classList.add('selected');
                    }
                });
            }
        }

        function vote(modelName) {
            results[data[index].id] = { choice: modelName, timestamp: new Date().toISOString() };
            render(); // Re-render to update classes
        }

        function nav(dir) {
            const newIndex = index + dir;
            if (newIndex >= 0 && newIndex < data.length) {
                index = newIndex;
                render();
            }
        }

        function downloadCSV() {
            const headers = ['id', 'preferred_model', 'timestamp'];
            let csv = headers.join(',') + '\n';
            
            data.forEach(item => {
                const res = results[item.id] || {};
                csv += `"${item.id}","${res.choice || 'Skipped'}","${res.timestamp || ''}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'comparison_results.csv';
            document.body.appendChild(a);
            a.click();
        }
    </script>
</body>
</html>
