<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Multi-Model Comparator</title>
    <link rel="stylesheet" href="styles/palette.css">
    <style>
        :root {
            --primary: #0f4c81;
            --primary-dark: #0a3559;
            --bg-top: #f5f7fb;
            --bg-bottom: #edf2fb;
            --card: #ffffff;
            --border: #d5dde7;
            --text: #0f172a;
            --section-default: #94a3b8;
            --font-heading: "Helvetica Neue", Helvetica, Arial, sans-serif;
            --font-body: "Times New Roman", Times, serif;
        }

        body {
            font-family: var(--font-body);
            background: radial-gradient(circle at top left, var(--bg-top), var(--bg-bottom));
            margin: 0;
            padding: 24px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            color: var(--text);
        }

        h1, h2, h3, h4, h5, h6,
        .panel-header,
        .context-title,
        .section-label,
        .meta-label,
        .section-chip,
        .summary-chips,
        .difference-pill,
        .btn,
        .vote-btn,
        .context-meta .meta-value {
            font-family: var(--font-heading);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            background: var(--card);
            padding: 12px 20px;
            border-radius: 16px;
            border: 1px solid var(--border);
            box-shadow: 0 15px 30px rgba(15, 76, 129, 0.08);
        }

        .grid-container {
            display: flex;
            gap: 18px;
            flex: 1;
            overflow: hidden;
            align-items: stretch;
            position: relative;
        }

        .comparison-summary {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 12px 18px;
            margin-bottom: 14px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .summary-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .difference-pill {
            border-radius: 999px;
            padding: 4px 12px;
            font-size: 0.8rem;
            font-weight: 600;
            border: 1px solid currentColor;
            background: transparent;
        }

        .panel {
            background: var(--card);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
            overflow: hidden;
            min-width: 180px;
            flex: 1 1 auto;
        }

        .context-panel {
            flex: 0 0 22%;
            background: #f8fafc;
            border-left: 6px solid var(--primary);
        }

        .panel-resizer {
            flex: 0 0 10px;
            cursor: col-resize;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            touch-action: none;
        }

        .panel-resizer::before {
            content: '';
            width: 2px;
            height: 70%;
            background: #cbd5e1;
            border-radius: 999px;
        }

        .panel-resizer:focus-visible::before,
        .panel-resizer:hover::before {
            background: var(--primary);
        }

        .panel-header {
            padding: 14px 18px;
            font-weight: 600;
            letter-spacing: 0.04em;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, rgba(15, 76, 129, 0.08), transparent);
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 18px;
            font-size: 0.95em;
            line-height: 1.6;
            white-space: normal;
            scroll-padding-top: 56px;
            min-width: 0;
        }

        .model-0-header { border-top: 6px solid #f97316; }
        .model-1-header { border-top: 6px solid #16a34a; }
        .model-2-header { border-top: 6px solid #0ea5e9; }
        .model-3-header { border-top: 6px solid #a855f7; }

        .btn {
            padding: 9px 18px;
            border: none;
            border-radius: 999px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s ease, background 0.2s ease;
        }

        .btn-nav { background: #dbe3ed; color: var(--text); }
        .btn-nav:hover { background: #c1ccda; }
        .btn-save { background: var(--primary); color: #fff; }
        .btn-save:hover { background: var(--primary-dark); }
        .btn:focus-visible { outline: 3px solid #ffbe0b; outline-offset: 3px; }
        .btn:active { transform: scale(0.98); }

        .vote-footer {
            padding: 12px;
            border-top: 1px solid var(--border);
            text-align: center;
            background: #f8fafc;
        }

        .vote-btn {
            width: 100%;
            padding: 9px;
            border: 1px solid #cbd5e1;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s ease, color 0.2s ease;
        }

        .vote-btn:hover { background: #e2e8f0; }
        .vote-btn.selected { background: #2563eb; color: #fff; border-color: #1e4ed8; }

        .context-content { display: flex; flex-direction: column; gap: 16px; }
        .context-section { display: flex; flex-direction: column; gap: 6px; }
        .context-title { font-size: 1.05em; font-weight: 600; color: #0f172a; }
        .context-meta { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; }
        .meta-label { font-size: 0.7em; text-transform: uppercase; letter-spacing: 0.08em; color: #94a3b8; margin-bottom: 2px; }
        .meta-value { font-weight: 600; color: #0f172a; }
        .section-label { font-size: 0.75em; text-transform: uppercase; letter-spacing: 0.08em; color: #94a3b8; margin-bottom: 4px; }
        .section-body { background: #f8fafc; border: 1px solid var(--border); border-radius: 12px; padding: 12px; min-height: 48px; }

        .model-section {
            margin-bottom: 18px;
            border-radius: 14px;
            border: 1px solid color-mix(in srgb, var(--section-accent, var(--border)) 35%, #ffffff);
            background: color-mix(in srgb, var(--section-accent, var(--border)) 8%, #ffffff);
            padding: 14px 14px 14px 22px;
            position: relative;
            scroll-margin-top: 80px;
        }

        .model-section::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 14px;
            bottom: 14px;
            width: 4px;
            border-radius: 2px;
            background: var(--section-accent, var(--section-default));
        }

        .model-section[data-highlight="diff"] {
            box-shadow: 0 0 0 2px color-mix(in srgb, var(--section-accent, var(--section-default)) 70%, #ffffff);
        }

        .section-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--text);
            background: color-mix(in srgb, var(--section-accent, var(--section-default)) 25%, rgba(255,255,255,0.9));
            border-radius: 999px;
            padding: 4px 12px;
            margin-bottom: 10px;
            border: 1px solid color-mix(in srgb, var(--section-accent, var(--section-default)) 45%, rgba(255,255,255,0.4));
        }

        .section-chip .section-icon { font-size: 0.85rem; }

        .model-empty {
            background: #fff7ed;
            border: 1px dashed #fdba74;
            border-radius: 12px;
            padding: 14px;
            color: #9a3412;
        }

        .context-footer { padding: 15px; border-top: 1px solid #ddd; font-size: 0.85em; background: #fff; }

        .rich-text p { margin: 0 0 6px 0; }
        .rich-text ul { margin: 0 0 6px 24px; }

        @media (prefers-reduced-motion: reduce) {
            * { transition-duration: 0.01ms !important; animation-duration: 0.01ms !important; }
        }
    </style>
</head>
<body onload="init()">

    <div class="header">
        <div style="display:flex; align-items:center; gap:15px;">
            <h2 style="margin:0; font-size:1.2em;">‚öñÔ∏è Multi-Model Comparator</h2>
            <span id="progress" style="background:#e2e8f0; padding:4px 8px; border-radius:4px; font-size:0.85em;">Loading...</span>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-nav" onclick="nav(-1)">Previous</button>
            <button class="btn btn-nav" onclick="nav(1)">Next</button>
            <button class="btn btn-save" onclick="downloadCSV()">üíæ Download Results</button>
        </div>
    </div>

    <div style="margin-bottom: 10px; display: flex; gap: 20px; align-items: center;">
        <div>
            <label for="project-select">Project: </label>
            <select id="project-select" onchange="onProjectChange()"></select>
        </div>
        <div id="model-select-container" style="display:none; position:relative;">
            <span id="model-select-summary" style="margin-right: 10px;">Select models</span>
            <button id="model-select-modify" onclick="openModelDropdown(event)" aria-haspopup="dialog" aria-controls="model-select-list">Modify</button>
            <div id="model-select-dialog" style="display:none; position:absolute; z-index:10; background:white; border:1px solid #ccc; border-radius:4px; margin-top:4px; min-width:220px; max-width:320px; max-height:220px; overflow:auto; box-shadow:0 2px 8px #0002;">
                <div style="padding:8px 12px; font-weight:bold;">Select models to compare</div>
                <ul id="model-select-list" role="listbox" aria-multiselectable="true" tabindex="-1" style="margin:0; padding:4px 0; list-style:none;"></ul>
                <div style="padding:8px 12px; text-align:right;">
                    <button onclick="closeModelDropdown()">Done</button>
                </div>
            </div>
        </div>
    </div>

    <div class="comparison-summary" id="comparison-summary" role="region" aria-live="polite">
        <strong>Preparing comparison snapshot‚Ä¶</strong>
    </div>
    <div class="grid-container" id="main-grid">
        <div class="panel context-panel" data-panel-index="0">
            <div class="panel-header">Context & Inputs</div>
            <div class="panel-content context-content">
                <div class="context-title" id="context-title">Issue context</div>
                <div class="context-meta">
                    <div>
                        <div class="meta-label">Project</div>
                        <div class="meta-value" id="context-project">‚Äî</div>
                    </div>
                    <div>
                        <div class="meta-label">Status</div>
                        <div class="meta-value" id="context-status">‚Äî</div>
                    </div>
                    <div>
                        <div class="meta-label">Priority</div>
                        <div class="meta-value" id="context-priority">‚Äî</div>
                    </div>
                    <div>
                        <div class="meta-label">Component</div>
                        <div class="meta-value" id="context-component">‚Äî</div>
                    </div>
                    <div>
                        <div class="meta-label">Version</div>
                        <div class="meta-value" id="context-version">‚Äî</div>
                    </div>
                    <div>
                        <div class="meta-label">Created</div>
                        <div class="meta-value" id="context-created">‚Äî</div>
                    </div>
                    <div>
                        <div class="meta-label">WCAG</div>
                        <div class="meta-value" id="context-wcag">‚Äî</div>
                    </div>
                </div>
                <div class="context-section">
                    <div class="section-label">Description</div>
                    <div class="section-body rich-text" id="context-text"></div>
                </div>
            </div>
            <div class="context-footer">
                <div>ID: <strong id="item-id"></strong></div>
                <div style="margin-top:5px;"><a id="source-link" href="#" target="_blank">üîó View Source URL</a></div>
            </div>
        </div>

        </div>

    <script>

        let allData = [];
        let data = [];
        let index = 0;
        let results = {}; // { id: { choice: 'model_filename', comment: '' } }
        let projects = [];
        let selectedProject = null;
        let allModels = [];
        let selectedModels = [];
        let modelDropdownOpen = false;
        const DEFAULT_CONTEXT_WIDTH = 22;
        const MIN_COLUMN_WIDTH = 8;
        const KEYBOARD_RESIZE_STEP = 2;
        let columnWidths = [];
        let activeResize = null;

        const SECTION_SLUGS = {
            'WCAG Mapping': 'wcag-mapping',
            'ACR Note': 'acr-note',
            'Developer Note': 'developer-note',
            'Thread TL;DR': 'thread-tldr',
            'Thread Problem': 'thread-problem',
            'Thread Sentiment': 'thread-sentiment',
            'Thread Timeline': 'thread-timeline',
            'Thread Links': 'thread-links',
            'Thread TODO': 'thread-todo',
            'Thread Journey': 'thread-journey'
        };

        const SECTION_THEMES = {
            'wcag-mapping': { icon: 'üß≠', label: 'WCAG Mapping', fallback: '#2563eb' },
            'acr-note': { icon: 'üìù', label: 'ACR Note', fallback: '#0284c7' },
            'developer-note': { icon: '‚öô', label: 'Developer Note', fallback: '#16a34a' },
            'thread-tldr': { icon: '‚ö°', label: 'Thread TL;DR', fallback: '#a855f7' },
            'thread-problem': { icon: '‚ùó', label: 'Thread Problem', fallback: '#ef4444' },
            'thread-sentiment': { icon: '‚ò∫', label: 'Thread Sentiment', fallback: '#0ea5e9' },
            'thread-timeline': { icon: '‚è±', label: 'Thread Timeline', fallback: '#f59e0b' },
            'thread-links': { icon: 'üîó', label: 'Thread Links', fallback: '#3b82f6' },
            'thread-todo': { icon: '‚òë', label: 'Thread TODO', fallback: '#ec4899' },
            'thread-journey': { icon: 'üßµ', label: 'Thread Journey', fallback: '#0f766e' }
        };

        const DEFAULT_SECTION_THEME = { color: 'var(--section-default)', icon: '‚Ä¢', label: 'Detail' };

        function clamp(value, min, max) {
            return Math.min(max, Math.max(min, value));
        }

        function slugifySection(label) {
            return (String(label || '')
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-+|-+$/g, '') || 'section');
        }

        function escapeHtml(text) {
            if (!text) return "";
            return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        function formatReport(text) {
            if (!text) return "";
            const lines = String(text).split('\n');
            let inUnorderedList = false;
            let inOrderedList = false;
            let inBlockquote = false;
            const htmlLines = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmedLine = line.trim();

                if (/^(#{1,6})\s+(.+)$/.test(trimmedLine)) {
                    if (inUnorderedList) { htmlLines.push('</ul>'); inUnorderedList = false; }
                    if (inOrderedList) { htmlLines.push('</ol>'); inOrderedList = false; }
                    if (inBlockquote) { htmlLines.push('</blockquote>'); inBlockquote = false; }
                    const match = trimmedLine.match(/^(#{1,6})\s+(.+)$/);
                    const level = match[1].length;
                    const content = escapeHtml(match[2]);
                    htmlLines.push(`<h${level} style="margin:8px 0 5px 0; font-weight:bold; color:#1e293b;">${content}</h${level}>`);
                } else if (/^>\s*/.test(trimmedLine)) {
                    if (inUnorderedList) { htmlLines.push('</ul>'); inUnorderedList = false; }
                    if (inOrderedList) { htmlLines.push('</ol>'); inOrderedList = false; }
                    if (!inBlockquote) {
                        htmlLines.push('<blockquote style="margin:10px 0; padding:10px 15px; border-left:4px solid #cbd5e1; background:#f8fafc; color:#475569;">');
                        inBlockquote = true;
                    }
                    const content = trimmedLine.replace(/^>\s*/, '');
                    const afterQuote = line.substring(line.indexOf('>') + 1);
                    if (/^\s{4,}/.test(afterQuote) || afterQuote.startsWith('\t')) {
                        htmlLines.push(`<div style="margin-left:20px; font-family:monospace; white-space:pre-wrap;">${escapeHtml(content)}</div>`);
                    } else if (content) {
                        htmlLines.push(`<div>${escapeHtml(content)}</div>`);
                    } else {
                        htmlLines.push('<div><br></div>');
                    }
                } else if (/^\d+\.\s+/.test(trimmedLine)) {
                    if (inUnorderedList) { htmlLines.push('</ul>'); inUnorderedList = false; }
                    if (inBlockquote) { htmlLines.push('</blockquote>'); inBlockquote = false; }
                    if (!inOrderedList) {
                        htmlLines.push('<ol style="margin:5px 0; padding-left:20px;">');
                        inOrderedList = true;
                    }
                    const content = trimmedLine.replace(/^\d+\.\s+/, '');
                    const processed = escapeHtml(content).replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    htmlLines.push(`<li style="margin-bottom:3px;">${processed}</li>`);
                } else if (/^[\*\-]\s+/.test(trimmedLine)) {
                    if (inOrderedList) { htmlLines.push('</ol>'); inOrderedList = false; }
                    if (inBlockquote) { htmlLines.push('</blockquote>'); inBlockquote = false; }
                    if (!inUnorderedList) {
                        htmlLines.push('<ul style="margin:5px 0; padding-left:20px; list-style-type:disc;">');
                        inUnorderedList = true;
                    }
                    const content = trimmedLine.replace(/^[\*\-]\s+/, '');
                    const processed = escapeHtml(content).replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    htmlLines.push(`<li style="margin-bottom:3px;">${processed}</li>`);
                } else {
                    if (inBlockquote && trimmedLine === '') {
                        if (i + 1 < lines.length && /^>\s*/.test(lines[i + 1].trim())) {
                            htmlLines.push('<div><br></div>');
                            continue;
                        } else {
                            htmlLines.push('</blockquote>');
                            inBlockquote = false;
                        }
                    }
                    if (inUnorderedList) { htmlLines.push('</ul>'); inUnorderedList = false; }
                    if (inOrderedList) { htmlLines.push('</ol>'); inOrderedList = false; }
                    if (trimmedLine) {
                        const processedLine = escapeHtml(line).replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                        htmlLines.push(processedLine);
                    } else {
                        if (htmlLines.length > 0 && htmlLines[htmlLines.length - 1] !== '<br>') {
                            htmlLines.push('<br>');
                        }
                    }
                }
            }

            if (inUnorderedList) { htmlLines.push('</ul>'); }
            if (inOrderedList) { htmlLines.push('</ol>'); }
            if (inBlockquote) { htmlLines.push('</blockquote>'); }
            while (htmlLines.length > 0 && htmlLines[htmlLines.length - 1] === '<br>') {
                htmlLines.pop();
            }
            return htmlLines.join('\n');
        }

        function renderJourney(text, issueUrl) {
            if (!text) return "No thread analysis available";
            let html = escapeHtml(text);
            html = html.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color:#2563eb; text-decoration:underline;">$1</a>');
            const parts = html.split(/(?=#\d+)/);
            if (parts.length > 1) {
                return '<div class="journey-list">' + parts.map(p => {
                    const trimmed = p.trim();
                    if (!trimmed) return '';
                    const match = trimmed.match(/^(#\d+)(.*)/s);
                    if (match) {
                        const id = match[1];
                        const content = match[2].trim();
                        const linkHref = issueUrl ? `${issueUrl}${id}` : '#';
                        return `<div class="journey-item" style="margin-bottom:2px;"><a href="${linkHref}" target="_blank" class="journey-id" style="font-weight:bold; color:#2563eb; margin-right:5px; text-decoration:none;">${id}</a><span class="journey-content">${content}</span></div>`;
                    }
                    return `<div class="journey-item" style="margin-bottom:2px;">${trimmed}</div>`;
                }).join('') + '</div>';
            }
            return html;
        }

        function renderList(text) {
            if (!text) return "";
            let html = escapeHtml(text);
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color:#2563eb; text-decoration:underline;">$1</a>');
            if (html.includes('\n')) {
                const lines = html.split('\n');
                const listItems = lines.map(line => {
                    const trimmed = line.trim();
                    const match = trimmed.match(/^[\*\-]\s+(.*)/);
                    if (match) {
                        return `<li>${match[1].trim()}</li>`;
                    }
                    return trimmed ? `<p>${trimmed}</p>` : '';
                }).join('');
                if (listItems.includes('<li>')) {
                    return `<ul style="padding-left:20px; margin:0;">${listItems}</ul>`;
                }
                return listItems;
            }
            if (html.match(/(?:^|\s)[\*\-]\s/)) {
                let list = html.replace(/^[\*\-]\s+/, '');
                const items = list.split(/\s+[\*\-]\s+/);
                const content = items.map(item => `<li>${item.trim()}</li>`).join('');
                return `<ul style="padding-left:20px; margin:0;">${content}</ul>`;
            }
            return html;
        }

        function setContextField(id, value) {
            const el = document.getElementById(id);
            if (!el) return;
            const text = value && String(value).trim() ? value : '‚Äî';
            el.textContent = text;
        }

        function getSectionLabel(slug) {
            const meta = SECTION_THEMES[slug];
            if (meta && meta.label) {
                return meta.label;
            }
            return slug
                .split('-')
                .map(part => part.charAt(0).toUpperCase() + part.slice(1))
                .join(' ');
        }

        function getAccentColor(slug, fallback) {
            const styles = getComputedStyle(document.documentElement);
            const value = styles.getPropertyValue(`--accent-${slug}`);
            if (value && value.trim()) {
                return value.trim();
            }
            return fallback || DEFAULT_SECTION_THEME.color;
        }

        function resolveSectionTheme(slug) {
            const meta = SECTION_THEMES[slug] || {};
            return {
                color: getAccentColor(slug, meta.fallback),
                icon: meta.icon || DEFAULT_SECTION_THEME.icon,
                label: meta.label || getSectionLabel(slug)
            };
        }

        function initializeColumnWidths(totalPanels) {
            if (totalPanels <= 0) {
                columnWidths = [];
                return;
            }
            if (totalPanels === 1) {
                columnWidths = [100];
                return;
            }
            const otherSlots = totalPanels - 1;
            let contextWidth = clamp(columnWidths[0] || DEFAULT_CONTEXT_WIDTH, 15, 45);
            const minNeededForOthers = otherSlots * MIN_COLUMN_WIDTH;
            if ((100 - contextWidth) < minNeededForOthers) {
                const minContext = 10;
                contextWidth = clamp(100 - minNeededForOthers, minContext, 60);
            }
            const remaining = Math.max(100 - contextWidth, 0);
            const perPanel = remaining / otherSlots;
            columnWidths = [contextWidth, ...Array(otherSlots).fill(perPanel)];
        }

        function ensureColumnWidths(totalPanels) {
            if (columnWidths.length !== totalPanels) {
                initializeColumnWidths(totalPanels);
            }
        }

        function applyColumnWidths() {
            const panels = document.querySelectorAll('[data-panel-index]');
            panels.forEach(panel => {
                const idx = Number(panel.dataset.panelIndex);
                if (Number.isNaN(idx) || columnWidths[idx] === undefined) return;
                const width = columnWidths[idx];
                panel.style.flexBasis = `${width}%`;
                panel.style.flexGrow = 0;
                panel.style.flexShrink = 1;
                panel.style.maxWidth = `${width}%`;
                panel.style.width = `${width}%`;
            });
        }

        function adjustColumnWidths(index, deltaPercent) {
            if (columnWidths.length <= index + 1) return;
            const left = columnWidths[index];
            const right = columnWidths[index + 1];
            const leftMin = Math.min(MIN_COLUMN_WIDTH, left);
            const rightMin = Math.min(MIN_COLUMN_WIDTH, right);
            const maxPositive = right - rightMin;
            const maxNegative = -(left - leftMin);
            const clampedDelta = Math.min(Math.max(deltaPercent, maxNegative), maxPositive);
            if (!clampedDelta) return;
            columnWidths[index] = left + clampedDelta;
            columnWidths[index + 1] = right - clampedDelta;
            applyColumnWidths();
        }

        function startResize(event, index) {
            event.preventDefault();
            const point = event.touches ? event.touches[0] : event;
            activeResize = {
                index,
                lastX: point.clientX
            };
            document.addEventListener('mousemove', handleResizeMove);
            document.addEventListener('touchmove', handleResizeMove, { passive: false });
            document.addEventListener('mouseup', stopResize);
            document.addEventListener('touchend', stopResize);
        }

        function handleResizeMove(event) {
            if (!activeResize) return;
            if (event.cancelable) event.preventDefault();
            const point = event.touches ? event.touches[0] : event;
            const deltaPx = point.clientX - activeResize.lastX;
            const grid = document.getElementById('main-grid');
            if (!grid) return;
            const rect = grid.getBoundingClientRect();
            if (!rect.width) return;
            const deltaPercent = (deltaPx / rect.width) * 100;
            adjustColumnWidths(activeResize.index, deltaPercent);
            activeResize.lastX = point.clientX;
        }

        function stopResize() {
            if (!activeResize) return;
            document.removeEventListener('mousemove', handleResizeMove);
            document.removeEventListener('touchmove', handleResizeMove, { passive: false });
            document.removeEventListener('mouseup', stopResize);
            document.removeEventListener('touchend', stopResize);
            activeResize = null;
        }

        function handleResizerKey(event, index) {
            if (event.key !== 'ArrowLeft' && event.key !== 'ArrowRight') return;
            event.preventDefault();
            const step = (event.shiftKey ? KEYBOARD_RESIZE_STEP * 2 : KEYBOARD_RESIZE_STEP) * (event.key === 'ArrowRight' ? 1 : -1);
            adjustColumnWidths(index, step);
        }

        function createResizer(index) {
            const resizer = document.createElement('div');
            resizer.className = 'panel-resizer grid-dynamic-item';
            resizer.setAttribute('role', 'separator');
            resizer.setAttribute('aria-orientation', 'vertical');
            resizer.setAttribute('aria-label', 'Resize column boundary');
            resizer.setAttribute('tabindex', '0');
            resizer.dataset.resizerIndex = index;
            const handleStart = event => startResize(event, index);
            resizer.addEventListener('mousedown', handleStart);
            resizer.addEventListener('touchstart', handleStart, { passive: false });
            resizer.addEventListener('keydown', event => handleResizerKey(event, index));
            return resizer;
        }

        function flagSectionDifferences() {
            const totalPanels = selectedModels.length || 0;
            const sectionMap = new Map();
            document.querySelectorAll('[data-model-panel]').forEach(panel => {
                panel.querySelectorAll('.model-section').forEach(section => {
                    const slug = section.dataset.section;
                    if (!slug) return;
                    if (!sectionMap.has(slug)) sectionMap.set(slug, []);
                    sectionMap.get(slug).push(section);
                });
            });

            const diffSections = new Set();
            sectionMap.forEach((sections, slug) => {
                const values = sections.map(section => {
                    const body = section.querySelector('.section-body');
                    return body ? body.innerText.trim() : '';
                });
                const unique = new Set(values.filter(Boolean));
                const missingPanels = Math.max(totalPanels - sections.length, 0);
                const emptyCount = values.filter(text => !text).length + missingPanels;
                const hasDiff = unique.size > 1 || (emptyCount > 0 && unique.size > 0) || sections.length !== totalPanels;
                sections.forEach(section => {
                    if (hasDiff) {
                        section.dataset.highlight = 'diff';
                        diffSections.add(slug);
                    } else {
                        section.removeAttribute('data-highlight');
                    }
                });
            });

            return diffSections;
        }

        function updateComparisonSummary(diffSections) {
            const summary = document.getElementById('comparison-summary');
            if (!summary) return;
            if (!data.length) {
                summary.innerHTML = '<strong>No comparison data available.</strong>';
                return;
            }
            if (!diffSections || diffSections.size === 0) {
                summary.innerHTML = '<strong>All visible sections align across selected models.</strong>';
                return;
            }
            const chips = Array.from(diffSections).map(slug => {
                const label = escapeHtml(getSectionLabel(slug));
                const color = resolveSectionTheme(slug).color || '#475569';
                return `<span class="difference-pill" style="color:${color}">${label}</span>`;
            }).join('');
            summary.innerHTML = `<strong>Differences highlighted (${diffSections.size})</strong><div class="summary-chips">${chips}</div>`;
        }

        function buildModelContent(model, issueUrl) {
            if (!model) {
                return '<div class="model-empty">This scan did not produce output for this issue.</div>';
            }
            const sections = [];
            const addSection = (label, value, renderer = formatReport) => {
                const text = value && String(value).trim() ? String(value) : '';
                if (!text) return;
                const slug = SECTION_SLUGS[label] || slugifySection(label);
                const theme = resolveSectionTheme(slug);
                const sectionId = `${slug}-${Math.random().toString(36).slice(2, 7)}`;
                sections.push(`
                    <section class="model-section" data-section="${slug}" style="--section-accent:${theme.color};">
                        <div class="section-chip" id="${sectionId}">
                            <span class="section-icon" aria-hidden="true">${theme.icon}</span>
                            <span class="section-label-text">${label}</span>
                        </div>
                        <div class="section-body rich-text" aria-labelledby="${sectionId}">${renderer(text, issueUrl)}</div>
                    </section>
                `);
            };

            addSection('WCAG Mapping', model?.ai_wcag, escapeHtml);
            addSection('ACR Note', model?.acr_note || model?.text);
            addSection('Developer Note', model?.dev_note);
            addSection('Thread TL;DR', model?.thread_tldr);
            addSection('Thread Problem', model?.thread_problem);
            addSection('Thread Sentiment', model?.thread_sentiment);
            addSection('Thread Timeline', model?.thread_timeline, renderJourney);
            addSection('Thread Links', model?.thread_links, renderList);
            addSection('Thread TODO', model?.thread_todo);
            addSection('Thread Journey', model?.thread_journey, renderJourney);

            if (sections.length === 0) {
                const fallback = model?.text ? formatReport(model.text) : '';
                return `<div class="model-empty">${fallback || 'No AI analysis captured for this scan.'}</div>`;
            }
            return sections.join('');
        }

        function buildAssetUrl(path) {
            const cleaned = (path || '').replace(/^\/+/, '');
            const currentPath = window.location.pathname || '/';
            let basePath = currentPath.replace(/[^\/]*$/, '');
            const lastSegment = currentPath.substring(currentPath.lastIndexOf('/') + 1);
            const looksLikeFile = lastSegment.includes('.');
            if (basePath === '/' && currentPath !== '/' && !looksLikeFile) {
                basePath = currentPath.endsWith('/') ? currentPath : currentPath + '/';
            }
            const baseUrl = window.location.origin + basePath;
            return new URL(cleaned, baseUrl).href;
        }

        async function init() {
            try {
                // Load projects with multiple runs
                const projRes = await fetch(buildAssetUrl('results/projects_with_multiple_runs.json'));
                const allProjectsObj = await projRes.json();
                // Load all comparison data
                const res = await fetch(buildAssetUrl('results/comparison.json'));
                let rawData = await res.json();
                // For each model in each item, check if its run folder exists by attempting to fetch its CSV file
                async function modelExists(model) {
                    // Use the csv_path property if present
                    if (!model.csv_path) return false;
                    try {
                        const test = await fetch(buildAssetUrl(model.csv_path), {method: 'HEAD'});
                        return test.ok;
                    } catch (e) { return false; }
                }
                // Filter models by existence
                async function filterModelsByExistence(data) {
                    let filtered = [];
                    for (const item of data) {
                        let validModels = [];
                        for (const m of item.models) {
                            if (await modelExists(m)) validModels.push(m);
                        }
                        if (validModels.length > 0) {
                            filtered.push({...item, models: validModels});
                        }
                    }
                    return filtered;
                }
                allData = await filterModelsByExistence(rawData);
                // Only include projects that have at least one valid model
                projects = Object.keys(allProjectsObj).filter(p =>
                    allData.some(item =>
                        item.project === p || item.models.some(m => m.model_name.startsWith(p + '-'))
                    )
                );
                const select = document.getElementById('project-select');
                select.innerHTML = '';
                if (projects.length === 0) {
                    select.innerHTML = '<option>No projects with multiple runs</option>';
                    document.getElementById('main-grid').style.display = 'none';
                    document.getElementById('progress').textContent = 'No projects to compare';
                    return;
                }
                projects.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p;
                    opt.textContent = p;
                    select.appendChild(opt);
                });
                selectedProject = projects[0];
                filterDataByProject();
            } catch (e) { console.error(e); }
        }

        function onProjectChange() {
            const select = document.getElementById('project-select');
            selectedProject = select.value;
            filterDataByProject();
        }

        function openModelDropdown(e) {
            e.preventDefault();
            modelDropdownOpen = true;
            // Update checkboxes to reflect current selectedModels
            const modelSelectList = document.getElementById('model-select-list');
            Array.from(modelSelectList.querySelectorAll('input[type=checkbox]')).forEach(cb => {
                cb.checked = selectedModels.includes(cb.value);
            });
            document.getElementById('model-select-dialog').style.display = '';
            modelSelectList.focus();
        }

        function closeModelDropdown() {
            modelDropdownOpen = false;
            document.getElementById('model-select-dialog').style.display = 'none';
            document.getElementById('model-select-modify').focus();
        }

        function onModelCheckboxChange() {
            const checkboxes = document.querySelectorAll('#model-select-list input[type=checkbox]');
            selectedModels = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
            if (selectedModels.length === 0 && allModels.length > 0) {
                selectedModels = [...allModels];
                checkboxes.forEach(cb => {
                    cb.checked = selectedModels.includes(cb.value);
                });
            }
            updateModelSummary();
            filterDataByProject(false);
        }

        function updateModelSummary() {
            const summary = document.getElementById('model-select-summary');
            summary.textContent = `${selectedModels.length}/${allModels.length} scans enabled`;
        }

        // Keyboard navigation for accessibility
        document.addEventListener('keydown', function(e) {
            if (!modelDropdownOpen) return;
            if (e.key === 'Escape') {
                closeModelDropdown();
            } else if (e.key === 'Tab') {
                // Trap focus inside dialog
                const dialog = document.getElementById('model-select-dialog');
                const focusable = dialog.querySelectorAll('button, [tabindex]:not([tabindex="-1"])');
                const first = focusable[0];
                const last = focusable[focusable.length-1];
                if (e.shiftKey ? document.activeElement === first : document.activeElement === last) {
                    e.preventDefault();
                    (e.shiftKey ? last : first).focus();
                }
            }
        });

        function filterDataByProject(resetModels = true) {
            // Get all models for this project
            const projectItems = allData.filter(item => {
                if (item.project) return item.project === selectedProject;
                return item.models.some(m => m.model_name.startsWith(selectedProject + '-'));
            });
            // Collect all unique model names for this project
            const modelSet = new Set();
            projectItems.forEach(item => {
                item.models.forEach(m => {
                    if (item.project === selectedProject || m.model_name.startsWith(selectedProject + '-')) {
                        modelSet.add(m.model_name);
                    }
                });
            });
            allModels = Array.from(modelSet);
            // If more than 2 models, show accessible summary and modify button
            const modelSelectDiv = document.getElementById('model-select-container');
            const modelSelectList = document.getElementById('model-select-list');
            if (allModels.length > 2) {
                modelSelectDiv.style.display = '';
                modelSelectList.innerHTML = '';
                allModels.forEach((m, idx) => {
                    const li = document.createElement('li');
                    li.setAttribute('role', 'option');
                    li.setAttribute('aria-selected', selectedModels.includes(m) ? 'true' : 'false');
                    li.style.display = 'flex';
                    li.style.alignItems = 'center';
                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.value = m;
                    cb.id = 'model-cb-' + idx;
                    cb.checked = selectedModels.includes(m);
                    cb.setAttribute('aria-label', m);
                    cb.onchange = onModelCheckboxChange;
                    li.appendChild(cb);
                    const lbl = document.createElement('label');
                    lbl.htmlFor = cb.id;
                    lbl.textContent = m;
                    lbl.style.marginLeft = '8px';
                    li.appendChild(lbl);
                    modelSelectList.appendChild(li);
                });
                // Select first 3-4 models by default or keep previous selection
                if (resetModels || selectedModels.length === 0) {
                    selectedModels = allModels.slice(0, Math.min(4, allModels.length));
                }
                updateModelSummary();
            } else {
                modelSelectDiv.style.display = 'none';
                selectedModels = [...allModels];
            }
            // Filter data to only include selected models
            data = projectItems.map(item => {
                // Only keep selected models for this item
                return {
                    ...item,
                    models: item.models.filter(m => selectedModels.includes(m.model_name))
                };
            }).filter(item => item.models.length > 0);
            index = 0;
            if (data.length > 0) {
                document.getElementById('main-grid').style.display = 'flex';
                generateLayout(getTemplateModels());
                render();
            } else {
                document.getElementById('main-grid').style.display = 'none';
                document.getElementById('progress').textContent = 'No data for selected project/models';
            }
        }

        // Close dropdown if clicking outside
        document.addEventListener('mousedown', function(e) {
            const dialog = document.getElementById('model-select-dialog');
            if (modelDropdownOpen && dialog && !dialog.contains(e.target) && e.target.id !== 'model-select-modify') {
                closeModelDropdown();
            }
        });

        function getTemplateModels() {
            if (!selectedModels || selectedModels.length === 0) return [];
            return selectedModels.map(name => {
                const source = (data.find(item => item.models.some(m => m.model_name === name)) ||
                    allData.find(item => item.models.some(m => m.model_name === name)));
                if (source) {
                    return source.models.find(m => m.model_name === name) || { model_name: name };
                }
                return { model_name: name };
            });
        }

        function generateLayout(models = []) {
            const grid = document.getElementById('main-grid');
            if (!grid) return;
            const contextPanel = grid.querySelector('.context-panel');
            if (contextPanel) {
                contextPanel.dataset.panelIndex = '0';
            }
            grid.querySelectorAll('.grid-dynamic-item').forEach(el => el.remove());
            const totalPanels = 1 + models.length;
            ensureColumnWidths(totalPanels);
            models.forEach((model, i) => {
                const modelName = model?.model_name || selectedModels[i] || `Model ${i + 1}`;
                if (grid.children.length > 0) {
                    const resizer = createResizer(i);
                    grid.appendChild(resizer);
                }
                const div = document.createElement('div');
                div.className = `panel model-${i}-header grid-dynamic-item`;
                div.setAttribute('data-model-panel', i);
                div.dataset.panelIndex = (i + 1).toString();
                div.innerHTML = `
                    <div class="panel-header">
                        <span>${escapeHtml(modelName)}</span>
                        <span style="font-size:0.8em; color:#666;">Model ${i+1}</span>
                    </div>
                    <div class="panel-content" id="model-content-${i}"></div>
                    <div class="vote-footer">
                        <button class="vote-btn" id="btn-vote-${i}" data-model="${escapeHtml(modelName)}" onclick="vote(this.dataset.model)">
                            Vote for Model ${i+1}
                        </button>
                    </div>
                `;
                grid.appendChild(div);
            });
            applyColumnWidths();
        }

        function render() {
            const item = data[index];
            document.getElementById('progress').textContent = `${index + 1} of ${data.length}`;
            const description = item.description || item.context || '';
            const formattedDescription = formatReport(description);
            document.getElementById('context-text').innerHTML = formattedDescription || '<em>No description provided.</em>';
            document.getElementById('context-title').textContent = item.title || `Issue ${item.id}`;
            setContextField('context-project', item.project || selectedProject || '‚Äî');
            setContextField('context-status', item.status || 'Unknown');
            setContextField('context-priority', item.priority || 'Unknown');
            setContextField('context-component', item.component || '‚Äî');
            setContextField('context-version', item.version || '‚Äî');
            setContextField('context-created', item.created || '‚Äî');
            setContextField('context-wcag', item.wcag_sc || '‚Äî');

            document.getElementById('item-id').textContent = item.id || '‚Äî';
            const url = item.source_url || '';
            const sourceLink = document.getElementById('source-link');
            if (url) {
                sourceLink.href = url;
                sourceLink.textContent = 'üîó View Source URL';
                sourceLink.removeAttribute('aria-disabled');
            } else {
                sourceLink.href = '#';
                sourceLink.textContent = 'No source link available';
                sourceLink.setAttribute('aria-disabled', 'true');
            }

            const totalPanels = selectedModels.length;
            const saved = results[item.id];
            for (let i = 0; i < totalPanels; i++) {
                const modelName = selectedModels[i];
                const modelData = item.models.find(m => m.model_name === modelName);
                const container = document.getElementById(`model-content-${i}`);
                if (container) {
                    container.innerHTML = buildModelContent(modelData, item.source_url);
                }
                const voteBtn = document.getElementById(`btn-vote-${i}`);
                if (voteBtn) {
                    voteBtn.dataset.model = modelName;
                    const isSelected = Boolean(saved && saved.choice === modelName);
                    voteBtn.setAttribute('aria-pressed', isSelected ? 'true' : 'false');
                }
            }

            // Restore Vote
            document.querySelectorAll('.vote-btn').forEach(b => b.classList.remove('selected'));
            if (saved) {
                selectedModels.forEach((name, i) => {
                    if (name === saved.choice) {
                        const btn = document.getElementById(`btn-vote-${i}`);
                        if (btn) {
                            btn.classList.add('selected');
                            btn.setAttribute('aria-pressed', 'true');
                        }
                    }
                });
            }

            const diffSections = flagSectionDifferences();
            updateComparisonSummary(diffSections);
        }

        function vote(modelName) {
            results[data[index].id] = { choice: modelName, timestamp: new Date().toISOString() };
            render(); // Re-render to update classes
        }

        function nav(dir) {
            const newIndex = index + dir;
            if (newIndex >= 0 && newIndex < data.length) {
                index = newIndex;
                render();
            }
        }

        function downloadCSV() {
            const headers = ['id', 'preferred_model', 'timestamp'];
            let csv = headers.join(',') + '\n';
            
            data.forEach(item => {
                const res = results[item.id] || {};
                csv += `"${item.id}","${res.choice || 'Skipped'}","${res.timestamp || ''}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'comparison_results.csv';
            document.body.appendChild(a);
            a.click();
        }
    </script>
</body>
</html>
