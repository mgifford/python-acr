<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Multi-Model Comparator</title>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --card: #ffffff; --border: #e2e8f0; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; height: 100vh; display: flex; flex-direction: column; overflow: hidden; color: #1e293b; }
        
        /* Layout */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: white; padding: 10px 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .grid-container { display: flex; gap: 15px; flex: 1; overflow: hidden; }
        
        /* Panels */
        .panel { background: var(--card); border-radius: 8px; display: flex; flex-direction: column; border: 1px solid var(--border); overflow: hidden; flex: 1; }
        .context-panel { flex: 0 0 20%; background: #f1f5f9; border-left: 4px solid var(--primary); }
        
        /* Headers & Content */
        .panel-header { padding: 12px; font-weight: bold; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .panel-content { flex: 1; overflow-y: auto; padding: 15px; font-size: 0.95em; line-height: 1.6; white-space: pre-wrap; }
        
        /* Model Specific Colors */
        .model-0-header { border-top: 4px solid #ef4444; } /* Red */
        .model-1-header { border-top: 4px solid #22c55e; } /* Green */
        .model-2-header { border-top: 4px solid #eab308; } /* Yellow */

        /* Buttons */
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-nav { background: #cbd5e1; color: #334155; }
        .btn-nav:hover { background: #94a3b8; color: white; }
        .btn-save { background: var(--primary); color: white; }
        
        /* Vote Footer */
        .vote-footer { padding: 10px; border-top: 1px solid var(--border); text-align: center; background: #f8fafc; }
        .vote-btn { width: 100%; padding: 8px; border: 1px solid #cbd5e1; background: white; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .vote-btn:hover { background: #e2e8f0; }
        .vote-btn.selected { background: #3b82f6; color: white; border-color: #3b82f6; }

    </style>
</head>
<body onload="init()">

    <div class="header">
        <div style="display:flex; align-items:center; gap:15px;">
            <h2 style="margin:0; font-size:1.2em;">‚öñÔ∏è Multi-Model Comparator</h2>
            <span id="progress" style="background:#e2e8f0; padding:4px 8px; border-radius:4px; font-size:0.85em;">Loading...</span>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-nav" onclick="nav(-1)">Previous</button>
            <button class="btn btn-nav" onclick="nav(1)">Next</button>
            <button class="btn btn-save" onclick="downloadCSV()">üíæ Download Results</button>
        </div>
    </div>

    <div class="grid-container" id="main-grid">
        <div class="panel context-panel">
            <div class="panel-header">Context & Inputs</div>
            <div class="panel-content" id="context-text"></div>
            <div style="padding:15px; border-top:1px solid #ddd; font-size:0.85em;">
                <div>ID: <strong id="item-id"></strong></div>
                <div style="margin-top:5px;"><a id="source-link" href="#" target="_blank">üîó View Source URL</a></div>
            </div>
        </div>

        </div>

    <script>
        let data = [];
        let index = 0;
        let results = {}; // { id: { choice: 'model_filename', comment: '' } }

        async function init() {
            try {
                const res = await fetch('/data/comparison');
                data = await res.json();
                if(data.length > 0) {
                    generateLayout(data[0].models);
                    render();
                } else {
                    alert("No data loaded.");
                }
            } catch (e) { console.error(e); }
        }

        function generateLayout(models) {
            const grid = document.getElementById('main-grid');
            // Keep context panel, remove old model panels if any
            while (grid.children.length > 1) { grid.removeChild(grid.lastChild); }

            models.forEach((model, i) => {
                const div = document.createElement('div');
                div.className = `panel model-${i}-header`;
                div.innerHTML = `
                    <div class="panel-header">
                        <span>${model.model_name}</span>
                        <span style="font-size:0.8em; color:#666;">Model ${i+1}</span>
                    </div>
                    <div class="panel-content" id="text-model-${i}"></div>
                    <div class="vote-footer">
                        <button class="vote-btn" id="btn-vote-${i}" onclick="vote('${model.model_name}')">
                            Vote for Model ${i+1}
                        </button>
                    </div>
                `;
                grid.appendChild(div);
            });
        }

        function render() {
            const item = data[index];
            document.getElementById('progress').textContent = `${index + 1} of ${data.length}`;
            document.getElementById('context-text').textContent = item.context;
            document.getElementById('item-id').textContent = item.id;
            document.getElementById('source-link').href = item.source_url || '#';

            // Render Model Texts
            item.models.forEach((model, i) => {
                document.getElementById(`text-model-${i}`).textContent = model.text;
            });

            // Restore Vote
            const saved = results[item.id];
            document.querySelectorAll('.vote-btn').forEach(b => b.classList.remove('selected'));
            if (saved) {
                // Find button that corresponds to the saved model name
                item.models.forEach((m, i) => {
                    if(m.model_name === saved.choice) {
                        document.getElementById(`btn-vote-${i}`).classList.add('selected');
                    }
                });
            }
        }

        function vote(modelName) {
            results[data[index].id] = { choice: modelName, timestamp: new Date().toISOString() };
            render(); // Re-render to update classes
        }

        function nav(dir) {
            const newIndex = index + dir;
            if (newIndex >= 0 && newIndex < data.length) {
                index = newIndex;
                render();
            }
        }

        function downloadCSV() {
            const headers = ['id', 'preferred_model', 'timestamp'];
            let csv = headers.join(',') + '\n';
            
            data.forEach(item => {
                const res = results[item.id] || {};
                csv += `"${item.id}","${res.choice || 'Skipped'}","${res.timestamp || ''}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'comparison_results.csv';
            document.body.appendChild(a);
            a.click();
        }
    </script>
</body>
</html>
